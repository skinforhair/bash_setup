#!/bin/bash

workingDIR="$HOME/.skinforhair_settings/bin/GLaDOS/media_library/lib/thetvdb"

token_file="$workingDIR/current_token"
if [ "$(cat $token_file)" == "" ]; then
 ./generate_token
fi

token=$(cat $token_file)

#showname="Rick and Morty"
showname="$1"
#convert spaces in showname to %20
showname=$(echo "$showname" |sed 's;\ ;%20;g')

TVjson=$(curl -X GET --header "Accept: application/json" --header "Authorization: Bearer ${token}" "https://api.thetvdb.com/search/series?name=${showname}")

#echo ${TVjson} >> jsonfile
#TVjson=$(cat jsonfile)

tvdbID=`echo "$TVjson" |jq '.data[]' |jq '.id' |sed 's/\"//g'`
firstAired=`echo "$TVjson" |jq '.data[]' |jq '.firstAired' |sed 's/\"//g'`
seriesName=`echo "$TVjson" |jq '.data[]' |jq '.seriesName' |sed 's/\"//g'`
seriesStatus=`echo "$TVjson" |jq '.data[]' |jq '.status' |sed 's/\"//g'`


#echo "id: $tvdbID"

nResults=$(echo "$tvdbID" |wc -l)
if [ $nResults -lt 1 ]; then
 echo "No results!"
elif [ $nResults -gt 1 ]; then
 echo "Show $showname has multiple results found!!"
 IFS=$'\n' a=(${firstAired[0]})
 IFS=$'\n' s=(${seriesStatus[0]})
 IFS=$'\n' n=(${seriesName[0]})
 IFS=$'\n' y=(${tvdbID[0]})
 tvdbID=
 while [ "$tvdbID" == "" ]; do
 c=1
 echo -e "N: tvdbID\tName\t\tFirst Aired\tStatus"
 echo "----------------------------------------"
 echo "0: CANCEL OPERATION"
  while [ $c -le ${#y[@]} ]; do
   d=$((c-1))
   echo -e "$c: ${y[$d]}\t${n[$d]}\t\t${a[$d]}\t${s[$d]}"
   c=$((c+1))
  done #while c -le array

  read -p "Please enter an ID: " inputID
  if [ "$inputID" == "0" ]; then
    exit 1
  else
    tvdbID="${y[$((inputID-1))]}"
  fi
 done
fi

echo "-------"
echo "Id is now"
echo "$tvdbID"
