#!/bin/bash

#outputfile=/etc/motd
outputfile=glados.tst
 NC='\033[0m' # no color
 red='\033[0;31m'
 green='\033[0;32m'
 black='\e[0;30m'
 white='\033[1;37m'
 yellow='\033[1;33m'
 cyan='\e[0;36m'
 gray='\033[0;37m'

WAN=$(dig +short myip.opendns.com @resolver1.opendns.com)
WheatWAN=`ssh -q cavejohnson@wheatley "dig +short myip.opendns.com @resolver1.opendns.com;exit"`
if [ "$WAN" == "$WheatWAN" ]; then
 VPN_WAN="${red}$WheatWAN${NC}"
else
 VPN_WAN="${cyan}$WheatWAN${NC}"
fi

function check_ssh() {
if (exec 3<>/dev/tcp/$1/22) 2> /dev/null; then
 echo 0
else
 echo 2
fi
} ##end check_ssh

function check_ping() {
 ping -c 1 $1 &> /dev/null; echo $?
} ##end check_ping

function check_host_online () {
 if [ "$2" == "ping" ]; then
  host_status="$(check_ping $1)"
 else
  host_status="$(check_ssh $1)"
 fi
 if [ "$host_status" == "0" ]; then
  echo -en "${green}Online ${NC}"
 else
  echo -en "${red}Offline${NC}"
 fi
} ##end check_host_online

function check_service_status() {
 serviceName="$1"
 processName="$2"
 SSTAT=$(ps -ef |grep $processName |grep -v grep)
 [ "$SSTAT" == "" ] && echo -e "${red}DN${NC}" || echo -e "${green}UP${NC}"
} ##end check_service_status

CortanaOnline="$(check_host_online 'cortana' 'ping')"
R2Online="$(check_host_online 'r2d2' 'ssh')"
ScholoOnline="$(check_host_online 'scholomance' 'ssh')"
BB8Online="$(check_host_online 'bb8' 'ssh')"
WheatleyOnline="$(check_host_online 'wheatley' 'ssh')"

FP="$(check_host_online 'frontporch' 'ping')"
EG="$(check_host_online 'eastgarage' 'ssh')"
BP="$(check_host_online 'backporch' 'ping')"
WG="$(check_host_online 'westgarage' 'ping')"
BY="$(check_host_online 'backyard' 'ping')"

APACHE="$(check_service_status 'Apache' 'httpd')"
SMB="$(check_service_status 'Samba' 'smb')"
MYSQL="$(check_service_status 'MySQL' 'mysql')"

i="${yellow}*${white}"
e="${NC}|${white}"

 
echo -e "${white}+-----------  ${yellow}.,-:;//;:-,  ${white}----------------------------------------------------------------" > $outputfile
echo -e "|         ${yellow}. :H000MM@M#H/.,+%;,     ${white}Welcome to GLaDOS       WAN IP: ${cyan}$WAN${NC}" >> $outputfile
echo -e "${white}+----  ${yellow},/X+ +M@@M@MM%=,-%HMMM@X/, ${white}---------------------------------------------------------" >> $outputfile
echo -e "${white}|    ${yellow}-+@MM    ${white} ============${yellow}MMMM@MMMM@+-            ${white}Hosts                   Pi's ${NC}" >> $outputfile
echo -e "${white}|   ${yellow};@M@@m    ${NC}//${white}\\\\\\         \\\\\\ ${yellow}HHH@M@M#@/. ${white}-----------------------------------------------------${NC}" >> $outputfile
echo -e "${white}| ${yellow}%MM@@MH     $e  ||  ____  ||${yellow} .---=-=:=,.     ${NC}Cortana    : $CortanaOnline   R2-D2      : $R2Online" >> $outputfile
echo -e "${white}| ${yellow}=@#@@@MX    $e  || /    \\ ||${yellow}  -%HXSS%%%+;    ${NC}Scholomance: $ScholoOnline   BB-8       : $BB8Online" >> $outputfile
echo -e "${white}|${yellow}=-./@M@MS    $e  ||$e      $e||${yellow}   .;@MMMM@MM:   ${NC}Wheatley   : $WheatleyOnline   VPN WAN : $VPN_WAN" >> $outputfile
echo -e "${white}|${yellow}X@/ -SMM/    $e  ||$e      $e||${yellow}     .+MM@@@M:${white} ---------------------------------------------------${NC}" >> $outputfile
echo -e "${yellow},@M@H: :0:    $e  ||$e      $e||${yellow}     . =X#@@@@-                   ${white}Cameras${NC}" >> $outputfile
echo -e "${yellow},@@@MMX, .    $e  ||$e  /$i\ $e||${yellow}     /H- ;@M@M= ${white}--------------------------------------------------${NC}" >> $outputfile
echo -e "${yellow}.H@@@@M@+,    $e  ||$e  $i$i$i $e||${yellow}     %MM+..%#$.  ${NC}FrontPorch : $FP${NC}   EastGarage : $EG${NC}" >> $outputfile
echo -e "${white}|${yellow}/MMMM@MMH/.  $e  ||$e  \\\\$i/ $e||${yellow}   XM@MH; =;   ${NC}BackPorch  : $BP${NC}   WestGarage : $WG${NC}" >> $outputfile
echo -e "${white}| ${yellow}/%+%SXHH@S= $e  ||$e      $e||${yellow} .H@@@@MX,    ${NC}BackYard   : $BY${NC}" >> $outputfile
echo -e "${white}|- ${yellow}.=--------.$e  || \\____/ ||${yellow},@@@@@MX, ${white}----------------------------------------------------${NC}" >> $outputfile
echo -e "${white}|  ${yellow}.%MM@@@HHHX$e  ||        ||${yellow}=M@@MM%.                      ${white}Services${NC}" >> $outputfile
echo -e "${white}|--  ${yellow}=XMMM@MM@${white}\\//========//${yellow}/MMMX=  ${white}------------------------------------------------------${NC}" >> $outputfile
echo -e "${white}|      ${yellow}-%@M@M#@S-.=S@MM@@@M; %M%-        ${NC}Apache : $APACHE${NC}       SMB : $SMB${NC}     MySQL : $MYSQL${NC}" >> $outputfile
echo -e "${white}|        ${yellow},:+S+-,/H#MMMMMMM@- -,${NC}           ${black}Generated `date`${NC}" >> $outputfile
echo -e "${white}+------------  ${yellow}=++%%%%+/:-.  ${white}--------------------------------------------------------------${NC}" >> $outputfile
