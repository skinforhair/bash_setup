#!/bin/bash


function EpGuideName() {
SHOWNAME=$(cleanShowName "$1")
Season=$2
Episode=$3
URL="http://epguides.com/"

#set new URL based on show name
URL="$URL"$SHOWNAME"/"

#echo "$Season-$Episode"

#get the line with the Episode title
if [ $Episode -lt 10 ]; then
 PageDump=`lynx -width 1000 -dump $URL |grep "$Season- $Episode" |grep -v "*" |head -1`
 if [ "$PageDump" == "" ]; then
   PageDump=`lynx -width 1000 -dump $URL |grep "$Season-$Episode" |grep -v "*" |head -1`
 fi
else
 PageDump=`lynx -width 1000 -dump $URL |grep "$Season-$Episode" |grep -v "*" |head -1`
fi

if [ "$PageDump" == "" ] && [ "${Episode:0:1}" == "0" ]; then
 PageDump=`lynx -width 1000 -dump $URL |grep "$Season- ${Episode:1:1}" |grep -v "*" |head -1`
 if [ "$PageDump" == "" ]; then
#echo -e "${yellow}--${Episode:1:1}--${NC}"
  PageDump=`lynx -width 1000 -dump $URL |grep "$Season-${Episode:1:1}" |grep -v "*" |head -1`
 fi
fi
if [ "$PageDump" == "" ]; then
  echo -e "ERR: PageDump is still blank."
  echo -e "URL: ${yellow}$URL${NC}"
  echo -e "${yellow}$Season-$Episode${NC}"
fi

#PageDump=`lynx -width 1000 -dump $URL |grep "$Season-$Episode" |head -1`
#if [ "$PageDump" == "" ] && [ "${Episode:0:1}" == "0" ]; then
# PageDump=`lynx -width 1000 -dump $URL |grep "$Season-${Episode:1:1}" |head -1`
#fi

#echo " ****  $PageDump   ****"

#clean out special characters
PageDump=`echo "$PageDump" | tr -d "'"`
PageDump=`echo "$PageDump" | tr -d "’"`
PageDump=`echo "$PageDump" | tr -d ","`
PageDump=`echo "$PageDump" | tr -d "?"`
PageDump=`echo "$PageDump" | tr -d "."`

echo "$PageDump"
}


function EpGuideName_local() {
SHOWNAME=$(cleanShowName "$1")
Season=$2
Episode=$3
newSeason=$4
URL="http://epguides.com/"

if [ "$newSeason" == "1" ]; then
 Season=$((Season+1))
 Episode=1
fi

#set new URL based on show name
PAGE=$PAGES$SHOWNAME".page"
if [ ! -f "$PAGE" ]; then
 MPAGE=$PAGES$SHOWNAME".manual"
 if [ ! -f "$MPAGE" ]; then
  PageDump=`lynx -width 1000 -dump "$URL$SHOWNAME"`
  echo "$PageDump" > $PAGE
 else
  PAGE=$MPAGE
 fi
fi
#echo "$Season-$Episode"

#get the line with the Episode title
if [ $Episode -lt 10 ]; then
 PageDump=`cat $PAGE |grep "$Season- $Episode" |grep -v "*" |grep -v "tvmaze.com"|head -1`
 if [ "$PageDump" == "" ]; then
   PageDump=`cat $PAGE |grep "$Season-$Episode" |grep -v "*" |grep -v "tvmaze.com"|head -1`
 fi
else
 PageDump=`cat $PAGE |grep "$Season-$Episode" |grep -v "*" |grep -v "tvmaze.com"|head -1`
fi

if [ "$PageDump" == "" ] && [ "${Episode:0:1}" == "0" ]; then
 PageDump=`cat $PAGE |grep "$Season- ${Episode:1:1}" |grep -v "*" |grep -v "tvmaze.com"|head -1`
 if [ "$PageDump" == "" ]; then
#echo -e "${yellow}--${Episode:1:1}--${NC}"
  PageDump=`cat $PAGE |grep "$Season-${Episode:1:1}" |grep -v "*" |grep -v "tvmaze.com"|head -1`
 fi
fi
if [ "$PageDump" == "" ]; then
  if [ "$newSeason" != "1" ]; then
	PageDump=$(EpGuideName_local "$1" "$2" "$3" "1")
  else
   echo -e "ERR: PageDump is still blank."
   echo -e "PAGE: ${yellow}$PAGE${NC}"
   echo -e "${yellow}$Season-$Episode${NC}"
  fi
fi

#PageDump=`lynx -width 1000 -dump $URL |grep "$Season-$Episode" |head -1`
#if [ "$PageDump" == "" ] && [ "${Episode:0:1}" == "0" ]; then
# PageDump=`lynx -width 1000 -dump $URL |grep "$Season-${Episode:1:1}" |head -1`
#fi

#echo " ****  $PageDump   ****"

#clean out special characters
PageDump=`echo "$PageDump" | tr -d "'"`
PageDump=`echo "$PageDump" | tr -d "’"`
PageDump=`echo "$PageDump" | tr -d ","`
PageDump=`echo "$PageDump" | tr -d "?"`
if [ "$SHOWNAME" != "MrRobot" ]; then
PageDump=`echo "$PageDump" | tr -d "."`
fi

echo "$PageDump"
}

