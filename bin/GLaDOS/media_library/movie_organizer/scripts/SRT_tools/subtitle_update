#!/bin/bash
dbTable="VideoLibrary.movies"
inputMovie="$1"

splitName=$(echo "$inputMovie" |sed "s;\.;\ ;g")
 arr=($splitName)
 arr_len=${#arr[@]}
 arr_len=$((arr_len-1))

for w in ${arr[@]}; do
 if [ "${w:0:2}" = "19" ] || [ "${w:0:2}" = "20" ] || [ "${w:1:2}" = "19" ] || [ "${w:1:2}" = "20" ] && [ "${w:0:1}" != "7" ]; then
        if [ "${w:0:1}" = "(" ]; then
                word=${w:1:$((${#w}-2))}
        fi
  #echo "year is $word"
    Year="$w"
     if [ ${Year:0:1} == "(" ]; then
        Year=${Year:1}
     fi
     if [ ${Year:$((${#Year}-1))} == ")" ]; then
        Year=${Year:0:$((${#Year}-1))}
     fi
    titleCount=0

    while [ $titleCount -lt $index ]; do
       Title="$Title ${arr[$titleCount]}"
       titleCount=$((titleCount+1))
    done

    Title=${Title:0}
   URLTitle=`echo "$Title" |sed 's/\ /%20/g'`
    URLTitle=`echo "$URLTitle" |sed 's/\:/%3A/g'`
 fi
 index=$((index+1)) 
done
 if [ "$Title" == "" ]; then
#       echo "Malformed file name. Please Check"
        Title="${arr[0]} ${arr[1]} ${arr[2]}"
        Title=`echo "$Title" |sed "s/'//g"`
        Title=`echo "$Title" |sed "s/â€™/\'/g"`
        URLTitle=`echo "$Title" |sed 's/\ /%20/g'`
#       exit 0;
 fi
if [ "${Title:0:1}" == " " ]; then
        Title=${Title:1}
fi
q="select id from $dbTable where title='$Title' and year='$Year'"
localID=$(echo "$q"|mysql -N)

if [ "$localID" != "" ]; then
 localPath=$(echo "select local_path from $dbTable where id='$localID'" |mysql -N)
 cursub=$(echo "select subtitle from $dbTable where id='$localID'"|mysql -N)
 newSRTname="${inputMovie:0:$((${#inputMovie}-3))}"
 newSRTname="$newSRTname""srt"
 if [ -f $newSRTname ]; then
   echo "I found $newSRTname."
   mv "$newSRTname" "$localPath"
   query="update $dbTable set subtitle='srt' where id='$localID'"
 else
   selection=
   while [ "$selection" == "" ]; do 
     echo -e "Change subtitle for ${yellow}\"$Title ($Year)\"${NC}.... from ${red}$cursub${NC}"
     echo -en "To: [${yellow}E${NC}]mbedded, [${yellow}B${NC}]urned in, [${yellow}F${NC}]oreign, [${yellow}S${NC}]RT, [${yellow}N${NC}]one : "
     read selection
     case "${selection,,}" in 
       "e" ) selection="embedded";;
       "b" ) selection="burnin";;
       "f" ) selection="foreign";;
       "s" ) selection="srt";;
       "n" ) selection="none";;
        *  ) selection="";;
     esac
  done
  if [ "$selection" != "$cursub" ]; then
    if [ "$selection" == "srt" ] && [ ! -f $newSRTname ]; then
      srtPath=""
      while [ ! -f "$srtPath" ]; do
       echo -en "I don't see an srt file. Please enter the full path: "
       read srtPath
       if [ -f "$srtPath" ]; then
        mv "$srtPath" "$localPath$newSRTname"
       fi
      done
     fi
    query="update $dbTable set subtitle='$selection' where id='$localID'"
  else
    query="select id,title,year,subtitle from $dbTable where id='$localID'"
  fi
 fi
  echo "$query"
  echo "$query" |mysql -N
else
 echo "No movie found."
fi
