#!/bin/bash


function json_title() {
 stringZ=`echo "$1" |jq '.title' |sed 's/\"//g'`
 echo $stringZ
} #END extract_json

function json_actors(){
 stringZ=`echo "$1" |jq '.credits' |jq '.cast[]' |jq '.name'`
  #Remove Commas from names
  stringZ=`echo $stringZ |sed 's;,\ Jr.\";\ Jr.\";g'`
  stringZ=`echo $stringZ |sed 's;,\ Jr\";\ Jr\";g'`

  stringZ=`echo $stringZ |sed 's;\"\ \";,\ ;g'`
  stringZ=`echo $stringZ |sed 's;\";;g'`
echo "$stringZ"
}

function json_characters(){
 stringZ=`echo "$1" |jq '.credits' |jq '.cast[]' |jq '.character'`
  #Remove Commas from names
  stringZ=`echo $stringZ |sed 's;,\ Jr.\";\ Jr.\";g'`
  stringZ=`echo $stringZ |sed 's;,\ Jr\";\ Jr\";g'`


  stringZ=`echo $stringZ |sed 's;\"\ \";,\ ;g'`
  stringZ=`echo $stringZ |sed 's;\";;g'`
echo "$stringZ"  
}

function json_crew_jobs(){
 stringZ=`echo $1 |jq '.credits' |jq '.crew[]' |jq '.job'`
  stringZ=`echo $stringZ |sed 's;\"\ \";,\ ;g'`
  stringZ=`echo $stringZ |sed 's;\";;g'`
echo "$stringZ"
}

function json_crew_names(){
 stringZ=`echo $1 |jq '.credits' |jq '.crew[]' |jq '.name'`
  #Remove Commas from names
  stringZ=`echo $stringZ |sed 's;,\ Jr.\";\ Jr.\";g'`
  stringZ=`echo $stringZ |sed 's;,\ Jr\";\ Jr\";g'`

  stringZ=`echo $stringZ |sed 's;\"\ \";,\ ;g'`
  stringZ=`echo $stringZ |sed 's;\";;g'`
echo "$stringZ"
}

function json_year(){
 stringZ=`echo $1 |jq '.release_date' |sed 's/\"//g'`
  stringZ=${stringZ:0:4}
 echo "$stringZ"
}

function json_keywords(){
  keywords=`echo $1 |jq '.keywords' |jq '.keywords[]' |jq '.name'`
   keywords=`echo $keywords |sed 's;\"\ \";,\ ;g'`
   keywords=`echo $keywords |sed 's;\";;g'`
 echo "$keywords"
}

function get_mpaa_rating() {
        ratings=($1)
        countries=($2)
	myCountry="US"
        counter=0
        while [ $counter -lt ${#ratings[@]} ]; do
                if [ "${countries[$counter]}" == '"'$myCountry'"' ]; then
                        myRating="${ratings[$counter]}"
                fi
                counter=$((counter+1))
        done
 if [ "$myRating" != "" ]; then
        myRating=`echo $myRating |sed 's;\";;g'`
 fi
echo "$myRating"
} #END get_mpaa_rating


function json_mpaa(){
  certifications=`echo $1 |jq '.releases' |jq '.countries[]' |jq '.certification'`
  countries=`echo $1 |jq '.releases' |jq '.countries[]' |jq '.iso_3166_1'`
  mpaa=$(get_mpaa_rating "$certifications" "$countries")
 echo "$mpaa"
}

function json_backdrop(){
 stringZ=`echo $1 |jq '.backdrop_path' |sed 's/\"//g'`
 stringZ="https://image.tmdb.org/t/p/original"$stringZ
echo "$stringZ"
}

function json_poster(){
 stringZ=`echo $1 |jq '.poster_path' |sed 's/\"//g'`
 stringZ="https://image.tmdb.org/t/p/original"$stringZ
echo "$stringZ"
}

function json_imdb(){
 echo $1 |jq '.imdb_id' |sed 's/\"//g'
}

function json_plot(){
 stringZ=`echo $1 |jq '.overview' |sed 's/\"//g'`
 stringZ=`echo "$stringZ" |sed 's/\\\//g'`
 echo "$stringZ"
}

function json_release(){
 echo $1 |jq '.release_date' |sed 's/\"//g'
}

function json_runtime(){
 echo $1 |jq '.runtime' |sed 's/\"//g'
}

function json_tagline(){
 echo $1 |jq '.tagline' |sed 's/\"//g'
}

function json_genres(){
 stringZ=`echo $1 |jq '.genres[]' |jq '.name'`
  stringZ=`echo $stringZ |sed 's;\"\ \";,\ ;g'`
  stringZ=`echo $stringZ |sed 's;\";;g'`
echo "$stringZ"
}

function search_tmdb(){
 if [ "$3" == "" ]; then
  #echo "get_tmdb_id" "$1" "$2"
  TMDB_ID=$(get_tmdb_id "$1" "$2")
 elif [ "$3" == "prompted" ]; then
  echo -en "Please enter a Title to search for: "
  read inTitle
  TMDB_ID=$(get_tmdb_id "$inTitle")
 else
  TMDB_ID=$(get_tmdb_id "$1")
 fi
 if [ "$TMDB_ID" == "" ]; then
   echo -e "Couldn't find ${yellow}$1 ${NC}(${yellow}$2${NC}). Please adjust filename and search again."
   exit 1
 fi

#echo "tmdb_id is $TMDB_ID"
 # echo -e "TMDB ID is ${yellow} $TMDB_ID ${NC}"
 movie_json=$(get_movie_json "$TMDB_ID")
 found=$(json_title "$movie_json" "title")
 foundcast=$(json_actors "$movie_json")
 foundyear=$(json_year "$movie_json")
 IFS=',' read -a cast <<< "$foundcast"
 echo -en "I found ${red} $found ($foundyear) ${NC} in TMDB\nstarring ${Cyan} "
 for i in 0 1 2 3; do
	echo -en "${cast[$i]},"
 done
   echo -e "${cast[4]} ${NC}"

  YesNo "Is this correct?" "y"
  if [ "$?" == "0" ]; then
   if [ "$3" == "prompted" ]; then
    exit 0
   elif [ "$3" == "noyear" ]; then
    search_tmdb "$1" "$2" "prompted" 
   else
    search_tmdb "$1" "$2" "noyear"
   fi
  else
   searchTerms[0]="$found"
   searchTerms[1]="$foundyear"
   searchTerms[25]="$TMDB_ID"
  fi
} #END search_tmdb

function populate_from_json() {
 TMDB_ID=${searchTerms[25]}
 movie_json=$(get_movie_json "$TMDB_ID")
        
  searchTerms[8]=$(json_runtime "$movie_json")
  searchTerms[9]=$(json_mpaa "$movie_json")
  searchTerms[10]=$(json_plot "$movie_json")
  searchTerms[11]=$(json_tagline "$movie_json")
  searchTerms[12]=$(json_actors "$movie_json")
  searchTerms[13]=$(json_characters "$movie_json")
  searchTerms[14]=$(json_crew_jobs "$movie_json")
  searchTerms[15]=$(json_crew_names "$movie_json")
  searchTerms[16]=$(json_release "$movie_json")
  searchTerms[17]=$(json_genres "$movie_json")
  searchTerms[18]=$(json_keywords "$movie_json")
  searchTerms[19]=$(json_poster "$movie_json")
  searchTerms[20]=$(json_backdrop "$movie_json")
  searchTerms[24]=$(json_imdb "$movie_json")
  searchTerms[25]=$TMDB_ID
} #END populate_from_json

function populate_from_db() {
searchTerms[8]=$(echo "select runtime from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[9]=$(echo "select mpaa from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[10]=$(echo "select plot from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[11]=$(echo "select tagline from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[12]=$(echo "select actors from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[13]=$(echo "select characters from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[14]=$(echo "select crew_jobs from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[15]=$(echo "select crew_names from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[16]=$(echo "select releasedate from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[17]=$(echo "select genres from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[18]=$(echo "select keywords from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[19]=$(echo "select poster_path from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[20]=$(echo "select backdrop_path from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[24]=$(echo "select imdb_id from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[25]=$(echo "select tmdb_id from $movieTable where id=$1" | mysql $dbOptions)
searchTerms[26]=$(echo "select tags from $movieTable where id=$1" | mysql $dbOptions)
} #END populate_from_db

