#!/bin/bash
########################################
### parseFilename
### Pulls out the Title, Year, Size,
### and Quality (if available) of the
### filename passed to it
########################################
function parseFilename() {
 stringZ="$1"
 while [[ $stringZ == *"/"* ]]; do
  slash=`expr index "$stringZ" "/"`
  stringZ=${stringZ:$slash}
  #echo "cut string down to $stringZ"
 done

 if [ "${stringZ:0:1}" == "[" ]; then
	endBrack=`expr index "$stringZ" "]"`
	if [ $endBrack -gt 0 ]; then
	 stringZ=${stringZ:$endBrack}
	fi
 fi

 stringZ=`echo "$stringZ" |sed 's/\./\ /g'`
  arr=($stringZ)
  arr_len=${#arr[@]}
  arr_len=$((arr_len-1))
  FileType=${arr[$arr_len]}
  fileSize=`du -m "$1" | cut -f1`
 index=0

 for x in ${arr[@]}
  do
   word="$x"
	## DEBUG ##
	##   echo -e "Processing ${yellow} $word ${NC}"
	
#if S0 or S1, then end title, start season, index++
#elif airdate, grab that, index++
   if [ "${word:0:2}" = "S0" ] || [ "${word:0:2}" = "s0" ] || [ "${word:1:2}" = "E0" ] || [ "${word:1:2}" = "e0" ]; then
	##   echo -e "Year is ${yellow} $word ${NC}"
      stoppoint=`expr index "$word" e`
      if [ "$stoppoint" == "0" ]; then stoppoint=`expr index "$word" E`; fi
      season="${word:1:$(($stoppoint-2))}"
      ep="${word:$stoppoint}"
      titleCount=0
      while [ $titleCount -lt $index ]; do
         Title="$Title ${arr[$titleCount]}"
         titleCount=$((titleCount+1))
      done
      Title=${Title:0}
      index=$((index+1))
   elif [ "${word:1:1}" = "x" ] || [ "${word:2:1}" = "x" ]; then
	if [[ "${word:0:1}" =~ $numbers ]]; then
		stoppoint=`expr index "$word" x`
		season="${word:0:$(($stoppoint-1))}"
		ep="${word:$stoppoint}"
      titleCount=0
      while [ $titleCount -lt $index ]; do
         Title="$Title ${arr[$titleCount]}"
         titleCount=$((titleCount+1))
      done
      Title=${Title:0}
      index=$((index+1))
	fi
   elif [ ${word:0:1} = "(" ] && [ ${word:10:1} = ")" ]; then
         airdate="${word:1:9}"
	index=$((index+1))
   fi
   index=$((index+1))
  done

 if [ "$Title" == "" ]; then
	loop=${#arr[@]}
	loop=$((loop-1))
	c=0
	for y in ${arr[@]}; do
		if [ $c -lt $loop ]; then	 
		 Title="$Title $y"
		 c=$((c+1))
		fi
	done
 fi

 if [ "${Title:0:1}" == " " ]; then
        Title=${Title:1}
 fi

 #if [ "${#season}" -lt 2 ] && [ $season -lt 10 ]; then
#	season="0$season"
# fi

# if [ "${#ep}" -lt 2 ] && [ $ep -lt 10 ]; then
#	ep="0$ep"
# fi

 outie[1]=$Title
 outie[2]=$season
 outie[3]=$ep
 outie[6]=$(get_media_type "$1")
 if [ "${outie[6]}" == "" ]; then
	outie[6]=$FileType
 fi
 outie[4]=$fileSize
 outie[5]=$(get_media_quality "$1")

 echo -e "Title|Season|epNum|size|quality|type"
 limit=$((limit+1))

 limit=${#outie[@]}
 limit=$((limit-1))
 i=1
 while [ $i -le $limit ]; do
    echo -en "${outie[$i]}|"
    i=$((i+1))
 done
    echo -e "${outie[$i]}"
} #END parseFilename

