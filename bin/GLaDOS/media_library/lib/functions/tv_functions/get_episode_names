#!/bin/bash

get_episode_names(){
SHOWNAME=$1
Season=$2
Episode=$3
Multi=$4
Title=
AirDate=

 echo -e "${white}Pulling from local json...${black}get_episode_names${NC}"
#check freshness of the json file. if more than 3 days old, refresh it.
episodeJSON="/shares/video/tv/$SHOWNAME/.showdata/episodeinfo.json"
#echo -e "checking ${yellow}$SHOWNAME${NC}  .. ${red}$episodeJSON${NC}"
#find "$episodeJSON" -mmin +4320 -exec $DIR/scripts/SeriesUpdate "$SHOWNAME" \;

line=$(get_next_episode_from_json "$1" "$2" "$3")
#echo "line is $line"
 LocalAirDate=$(echo "$line" |awk '{print $3"-"$4"-"$5}')
 LocalTitle=$(echo "$line" |awk '{for(i=6;i<NF;i++)printf"%s",$i OFS;if(NF)printf"%s",$NF;printf ORS}' |tr ' ' '.')


#echo "Multi is $Multi"
if [ $Multi -gt 1 ]; then
 c=2
 e=$Episode
 while [ $c -le $Multi ]; do
  c=$((c+1))
  e=$((e+1))
  l2=$(get_next_episode_from_json "$1" "$2" "$e")
  lt2=$(echo "$l2" |awk '{for(i=6;i<NF;i++)printf"%s",$i OFS;if(NF)printf"%s",$NF;printf ORS}' |tr ' ' '.')
  LocalTitle="$LocalTitle-$lt2"
 done
fi 



#echo "LocalTitle is $LocalTitle"
#remove commas from title
LocalTitle=${LocalTitle//\,//}
#remove quotes from title
LocalTitle=${LocalTitle//\"/}
LocalTitle=${LocalTitle//\'/}
LocalTitle=${LocalTitle//\â€™/}
#remove colons from title
LocalTitle=${LocalTitle//\:/}
#remove slashes from title
LocalTitle=${LocalTitle//\//-}
LocalTitle=$(echo "$LocalTitle" |sed 's;\.\.;\.;g')
#echo "LocalTitle is $LocalTitle"
if [ "$LocalTitle" == "FAIL" ]; then
  echo "No episode name found in json for $1. exiting."
  #$DIR/scripts/SeriesUpdate "$1"
  exit 1;
else

#tack on the Air date
 if [ "${LocalTitle:$((${#LocalTitle}-1))}" == "." ];then
   LocalTitle="${LocalTitle:0:$((${#LocalTitle}-1))}"
 fi
 t="$LocalTitle"
 LocalTitle="$LocalTitle.($LocalAirDate)"
 echo -en "${yellow}$1 ${NC}Season ${blue}$2 ${NC}Episode ${white}$3"
  if [ $Multi -gt 1 ]; then
   cntr=1
   e2=$(($3+1))
   while [ $cntr -lt $Multi ]; do
     if [ $e2 -lt 10 ] && [ ${#e2} -lt 2 ]; then
      e2="0$e2"
     fi
     echo -en "${NC}-${white}$e2"
     cntr=$((cntr+1))
   done
  fi #if Multi
 echo -e "${NC}: (${yellow}$LocalAirDate${NC}) - ${white}$t${NC}"
Title="$LocalTitle"
AirDate="$LocalAirDate"
fi
} ##end get_episode_names

