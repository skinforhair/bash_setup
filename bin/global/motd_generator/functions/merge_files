#!/bin/bash

#TEMP
#MOTD="motd.txt"
#WRAP="aperture.wrapper"
#TABLE="tables.txt"
#HEAD="../data/headers/header.table"
#TABLES="../data/tables"
#MOTD_WIDTH=92
#LOGO_WIDTH=41
#white='\033[1;37m'
#AC1=$white
#NC='\033[0m'
#TEMP

function chop_off(){
 stringZ="$1"
  stringY=$(stripcolors "$stringZ")
 while [ ${#stringY} -gt $MOTD_WIDTH ]; do
  stringZ=${stringZ:0:$((${#stringZ}-1))}
  stringY=$(stripcolors "$stringZ")
 done
 echo -en "$stringZ"
} ##chop_off

function merge_tables(){
 if [ -f $TABLE ]; then rm -rf $TABLE; fi
 if [ -f $HEAD ]; then
   cat "$HEAD" >> $TABLE
 fi
 for f in $TABLES/*.table; do
  if [ "$f" != "$HEAD" ]; then
   cat "$f" >> $TABLE
  fi
 done
} ##merge_tables

function merge_files(){
s=$(log_action "MERGING" "start")
echo -en "$(tail -1 $LOGFILE)"
WRAP="$1"
merge_tables

W=$(cat $WRAP |wc -l)
T=$(cat $TABLE |wc -l)
c=1;


wline=$(cat $WRAP |head -$c |tail -1)
 wline=$(chop_off "$wline")
echo "${wline}" > $MOTD

while [ $c -lt $W ] || [ $c -lt $T ]; do
 c=$((c+1))
 if [ $c -le $W ]; then
  wline=$(cat $WRAP |head -$c |tail -1)
  wline=$(chop_off "$wline")
  cwline=$(stripcolors "$wline")
 else
  wline="${AC1}| ${NC}"
  cwline="| "
 fi  ##if c < W

 if [ $c -le $T ]; then
  tline=$(cat $TABLE |head -$c |tail -1)
   testLine=$(stripcolors "$tline")
   if [ "${testLine:0:2}" == "+-" ]; then
     len=${#cwline}
     if [ $len -eq 2 ]; then
       wline=
      cwline=
         len=0
     fi
     tline=$(underline "$len")
   fi
   if [ "${testLine:0:8}" == "cENTERED" ]; then
     tline=$(center_text "${tline:8}" "$(($c>$W))")
   fi

     if [ $c -le $W ]; then
      if [ $c -eq $W ] && [ "${testLine:0:2}" != "+-" ]; then
       wline=$(echo -e "$wline" |awk '{$NF=""}1')
      fi
       if [ "${testLine:0:2}" != "+-" ]; then
         cwline=$(stripcolors "$wline")
         while [ ${#cwline} -le $LOGO_WIDTH ]; do
           wline="$wline "
           cwline=$(stripcolors "$wline")
         done
       fi ##if +-     
     fi ## c <= W
 else
   tline=""
 fi ## if c <= T

 echo -e "${wline}${tline}" >> $MOTD
done
 t=$(($(date +%s)-$s))
 e=$(log_action "[$t seconds]" "end")
 RunningTime=$(($RunningTime+$t))
 echo -e "[Done] ($t seconds)"
} ## merge_files

